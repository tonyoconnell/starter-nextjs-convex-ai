# Environment Management in Monorepo

This guide explains how environment variables are managed across the monorepo to avoid duplication and ensure consistency.

## üèóÔ∏è Architecture

### Single Source of Truth
- **Root `.env.local`** - Master environment file containing all variables
- **App-specific files** - Auto-generated from root file using sync script

### Directory Structure
```
‚îú‚îÄ‚îÄ .env.example              # Template with all variables documented
‚îú‚îÄ‚îÄ .env.local                # Master environment file (DO NOT COMMIT)
‚îú‚îÄ‚îÄ apps/web/.env.local       # Auto-generated Next.js env (DO NOT EDIT)
‚îî‚îÄ‚îÄ scripts/sync-env.sh       # Environment sync script
```

## üöÄ Usage

### Initial Setup
1. Copy the template:
   ```bash
   cp .env.example .env.local
   ```

2. Fill in your actual values:
   ```bash
   # Edit .env.local with your API keys and secrets
   nano .env.local
   ```

3. Sync environment variables:
   ```bash
   bun run sync-env
   ```

### Development Workflow
1. **Always edit the root `.env.local`** - Never edit app-specific env files
2. **Run sync after changes**:
   ```bash
   bun run sync-env
   ```
3. **Restart services** to pick up new variables:
   ```bash
   bun dev                    # Restart Next.js
   cd apps/convex && bunx convex dev  # Restart Convex
   ```

## üîê Security Best Practices

### Environment File Security
- ‚úÖ Root `.env.local` contains all secrets
- ‚úÖ App files are auto-generated (clearly marked)
- ‚úÖ Template `.env.example` has no real secrets
- ‚úÖ All env files are in `.gitignore`

### Secret Management
```bash
# Generate secure OAuth secret
openssl rand -base64 32

# Example secure environment variables
OAUTH_SECRET=EsmURKt0YSKTaFzsSUb37dotZvo2zJx1PpzC64GiBYc=
OPENROUTER_API_KEY=sk-or-v1-actual-key-here
```

## üéØ Why This Approach?

### Problems with Multiple .env Files
- **Duplication** - Same variables in multiple files
- **Sync Issues** - Easy to forget updating all locations  
- **Security Risks** - Secrets scattered across directories
- **Maintenance** - Hard to track what goes where

### Benefits of Centralized Management
- **Single Source** - All variables in one place
- **Automatic Sync** - Script ensures consistency
- **Clear Ownership** - Root file is master, others are generated
- **Better Security** - Secrets in one protected location

## üõ†Ô∏è Technical Details

### How Convex Finds Environment Variables
When running `bunx convex dev` from `apps/convex/`:
1. Looks for `.env.local` in current directory (`apps/convex/`)
2. Walks up directory tree to project root
3. Finds and loads root `.env.local`

### Next.js Environment Loading
Next.js automatically loads environment files in this order:
1. `apps/web/.env.local` (app-specific, auto-generated)
2. `.env.local` (root, fallback)
3. `.env.example` (template only)

### Sync Script Logic
The `scripts/sync-env.sh` script:
1. Reads root `.env.local`
2. Filters variables needed by Next.js (NEXT_PUBLIC_, PORT, auth vars)
3. Generates `apps/web/.env.local` with clear "DO NOT EDIT" warnings
4. Preserves security by not copying server-only secrets to frontend

## üîß Troubleshooting

### Environment Not Loading
```bash
# Check if root env exists
ls -la .env.local

# Verify sync worked
cat apps/web/.env.local

# Check Convex can see variables
cd apps/convex && bunx convex dev
```

### Variables Not Available in App
1. Check variable is in root `.env.local`
2. Run sync: `bun run sync-env`  
3. Restart development servers
4. Check variable name follows Next.js conventions (`NEXT_PUBLIC_` for client-side)

### Security Audit
```bash
# Check no secrets are committed
git log --oneline -p | grep -i "api_key\|secret\|password"

# Verify .gitignore working
git status --ignored | grep env
```

## üìù Environment Variables Reference

### Required for Basic Functionality
- `CONVEX_DEPLOYMENT` - Auto-generated by Convex
- `NEXT_PUBLIC_CONVEX_URL` - Convex client endpoint
- `OPENROUTER_API_KEY` - Required for chat functionality

### Authentication (OAuth)
- `GITHUB_CLIENT_ID` & `GITHUB_CLIENT_SECRET`
- `GOOGLE_CLIENT_ID` & `GOOGLE_CLIENT_SECRET`  
- `OAUTH_SECRET` - For session encryption

### Optional
- `OPENAI_API_KEY` - For embeddings/advanced features
- `LLM_MODEL` & `LLM_FALLBACK_MODEL` - Model configuration
- Cloudflare Vectorize variables - For vector search

See `.env.example` for complete list with setup instructions.
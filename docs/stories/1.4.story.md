# Story 1.4: Convex Backend Integration

## Status

Ready

## Story

**As a** developer,
**I want** the Next.js frontend to be connected to a Convex backend project,
**so that** the foundation for real-time data and server logic is in place.

## Acceptance Criteria

1. A new Convex project is initialized and linked to the `apps/convex` directory.
2. The `ConvexProvider` is correctly configured to wrap the Next.js application.
3. A simple test query is created in Convex and called from the homepage to confirm the connection.

## Tasks / Subtasks

- [ ] Task 1: Initialize Convex project structure (AC: 1)
  - [ ] Install Convex CLI and client dependencies
  - [ ] Initialize Convex project in `apps/convex` directory
  - [ ] Configure Convex schema with basic test structure
  - [ ] Set up Convex environment and deployment configuration
- [ ] Task 2: Integrate ConvexProvider with Next.js application (AC: 2)
  - [ ] Install `convex` and `@convex-dev/react` packages in web app
  - [ ] Configure ConvexProvider in Next.js app root layout
  - [ ] Set up environment variables for Convex connection
  - [ ] Ensure TypeScript integration with Convex client
- [ ] Task 3: Create and test basic Convex query (AC: 3)
  - [ ] Create a simple test query function in Convex backend
  - [ ] Implement React hook to call the query from homepage
  - [ ] Add loading and error states for the query
  - [ ] Verify real-time data connection works properly
- [ ] Task 4: Validate integration and deployment compatibility
  - [ ] Test local development with both Next.js and Convex
  - [ ] Ensure Cloudflare Pages deployment still works
  - [ ] Verify no conflicts with existing monorepo structure
  - [ ] Add appropriate testing for the integration

## Documentation Impact Assessment

This story establishes foundational patterns for the Convex backend integration:

- **Convex Integration Pattern**: Provider configuration and React hooks pattern for real-time data
- **Monorepo Convex Structure**: How to organize Convex backend within Turborepo monorepo
- **Environment Configuration**: Setting up Convex environment variables and deployment
- **Real-time Data Pattern**: Basic query pattern for connecting frontend to Convex backend
- **Testing Integration**: Testing strategies for Convex backend and frontend integration

This implementation will create new patterns that should be documented for:

- Convex provider setup and configuration
- Real-time query patterns with React hooks
- Development workflow with Convex backend
- Deployment coordination between Next.js and Convex

## Dev Notes

### Previous Story Insights

From **Story 1.3 - Cloudflare Pages Deployment**:

- Next.js 14.2.15 application successfully deployed to Cloudflare Pages with static export
- TypeScript strict mode configured and working in production
- Tailwind CSS integrated and working on live deployment
- Build process optimized for Cloudflare Pages with `output: 'export'` configuration
- Environment variables properly configured for CI/CD pipeline
- Auto-deployment pipeline working with Git integration
- No conflicts with monorepo structure and deployment

### Tech Stack Configuration

Based on architecture documents, the following backend technologies must be used:

- **Convex**: 1.12.x for real-time backend platform, database, and functions [Source: architecture/tech-stack.md]
- **Next.js**: 14.2.x with App Router and TypeScript integration [Source: architecture/tech-stack.md]
- **Zod**: 3.23.x for schema validation and type enforcement [Source: architecture/tech-stack.md]
- **TypeScript**: 5.4.x with strict mode enabled [Source: architecture/tech-stack.md]
- **Bun**: 1.1.x for package management and monorepo tooling [Source: architecture/tech-stack.md]

### Data Models and Schema

The Convex backend must implement the following data models:

**Initial Schema Structure**:

- `users` table with \_id, name, email, profile_image_url, role, \_creationTime [Source: architecture/data-models.md]
- `chat_sessions` table for future chat functionality [Source: architecture/data-models.md]
- `chat_messages` table for message storage [Source: architecture/data-models.md]
- `log_entries` table with correlation_id, user_id, level, message, source, context [Source: architecture/data-models.md]

**For this story, implement minimal test schema**:

- Basic test table or function to verify connection
- No complex relationships needed initially
- Focus on connection validation rather than full schema

### Project Structure Requirements

The Convex integration must follow the established project structure:

```plaintext
/
├── apps/
│   ├── web/                 # Next.js frontend application
│   └── convex/              # Convex backend app
│       ├── schema.ts        # Database schema definition
│       ├── queries.ts       # Query functions
│       └── ...             # Additional backend functions
├── packages/
│   ├── data-access/         # Repository pattern implementation
│   └── shared-types/        # Shared TypeScript types
```

[Source: architecture/source-tree.md]

### API Specifications

The Convex backend functions must implement:

**Basic Query Functions**:

- Simple test query for connection validation
- Future implementation: `users:getCurrentUser()`: `Query<UserProfile | null>` [Source: architecture/api-implementation-details.md]
- Future implementation: `chat:listSessions()`: `Query<ChatSession[]>` [Source: architecture/api-implementation-details.md]

**For this story**:

- Create minimal test query to validate connection
- Follow Convex function signature patterns
- Ensure TypeScript integration with query return types

### File Locations

Following the established project structure:

**Convex Configuration**:

- `apps/convex/convex.json` - Convex project configuration
- `apps/convex/schema.ts` - Database schema definition
- `apps/convex/queries.ts` - Query functions for data access
- `apps/convex/_generated/` - Generated Convex types and client

**Next.js Integration**:

- `apps/web/app/layout.tsx` - Updated with ConvexProvider wrapper
- `apps/web/lib/convex.ts` - Convex client configuration
- `apps/web/.env.local` - Environment variables for Convex connection
- `apps/web/package.json` - Updated with Convex dependencies

**Shared Configuration**:

- Root `package.json` - Updated with Convex scripts if needed
- `turbo.json` - Updated with Convex development tasks

### Technical Constraints

From architecture requirements and Convex platform specifications:

**Convex Integration**:

- Must work with Next.js App Router and TypeScript strict mode
- Real-time subscriptions through React hooks integration
- Server-side functions with type-safe client generation
- Compatible with Cloudflare Pages deployment (client-side only)

**Environment Configuration**:

- Convex URL and deployment key configuration
- Development vs production environment separation
- Environment variables for frontend connection
- No server-side rendering conflicts with static export

**Monorepo Integration**:

- Bun package manager compatibility with Convex CLI
- Turborepo integration with Convex development workflow
- TypeScript workspace references for shared types
- Development script coordination between Next.js and Convex

### Coding Standards

The Convex integration must follow established standards:

**TypeScript Requirements**:

- Strict mode enabled for all Convex functions [Source: architecture/coding-standards.md]
- No `any` type usage in Convex schemas or functions [Source: architecture/coding-standards.md]
- Full type safety with generated Convex client types [Source: architecture/coding-standards.md]

**Configuration Pattern**:

- No direct `process.env` access in client code [Source: architecture/coding-standards.md]
- Centralized configuration management for Convex connection [Source: architecture/coding-standards.md]
- Environment-specific configurations for development and production

**Repository Pattern** (Future Implementation):

- All data access through repository pattern [Source: architecture/coding-standards.md]
- Separation of business logic from data access [Source: architecture/coding-standards.md]
- Abstract data layer for testability

### Performance Considerations

For optimal Convex integration:

**Real-time Performance**:

- Convex queries automatically subscribe to real-time updates
- Optimistic updates for improved user experience
- Efficient query caching and invalidation
- Minimal over-fetching with precise query design

**Build and Development**:

- Fast development workflow with Convex dev server
- TypeScript compilation performance with generated types
- Minimal bundle size impact from Convex client
- Compatible with Next.js static export for Cloudflare Pages

### Pattern Validation

Reference existing patterns that must be followed during implementation:

- React Provider pattern for context management (existing in Next.js app)
- TypeScript integration patterns (established in previous stories)
- Environment configuration patterns (established in Story 1.3)
- Development workflow patterns (established with monorepo setup)

This story will establish new foundational patterns for:

- Convex provider integration with Next.js
- Real-time query hooks with React
- Backend function development in monorepo
- Type-safe client-server communication

### Testing

List Relevant Testing Standards from Architecture the Developer needs to conform to:

- **Unit Testing**: Jest/RTL for React components using Convex hooks [Source: architecture/test-strategy-and-standards.md]
- **Integration Testing**: Ephemeral Convex environments for backend function testing [Source: architecture/test-strategy-and-standards.md]
- **Coverage Requirements**: 90% coverage requirement for shared packages [Source: architecture/test-strategy-and-standards.md]
- **CI/CD Integration**: All tests integrated into pipeline [Source: architecture/test-strategy-and-standards.md]

For this Convex integration story, testing involves:

- Test the ConvexProvider setup and configuration
- Test the basic query function works correctly
- Test React hook integration with Convex client
- Test real-time subscription functionality
- Test error handling and loading states
- Integration test with existing Next.js application
- Verify no regression in Cloudflare Pages deployment

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-07-17 | 1.0     | Initial story creation | Story Manager (SM) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review of the completed story implementation_

### Pattern Compliance Review

_To be filled by QA agent_

### Knowledge Capture

_To be filled by QA agent_

# Story 3.5: On-Demand Log Visualization & Clean Admin Interface

## Status

Ready

## Story

**As a** developer,
**I want** a clean debugging interface that fetches logs on-demand from Redis storage and provides trace correlation analysis,
**so that** I can efficiently debug issues without real-time overhead.

## Acceptance Criteria

1. A new `/debug` interface allows trace ID search to fetch logs from Redis storage on-demand.
2. Timeline visualization displays chronological logs across all systems (browser, Convex, workers) with system filtering.
3. Convex integration fetches logs from Redis only during active debugging sessions, not for real-time processing.
4. Log correlation engine operates on fetched data to provide error chain analysis and performance insights.
5. **Claude Code Integration**: Structured log export functionality for AI debugging assistance and pattern analysis.
6. **Developer Experience**: Clean, focused interface optimized for debugging workflows rather than real-time monitoring.

## Estimation & Planning

### Story Points

8

### Estimated Complexity

Medium-High

### Estimated Time

3-4 days

### Risk Level

Medium

## Tasks / Subtasks

- [ ] Task 1: Create Debug Interface Layout (AC: 1, 6)
  - [ ] Set up `/debug` page in Next.js app directory
  - [ ] Create clean, developer-focused UI layout with trace ID search
  - [ ] Implement responsive design for debugging workflows
  - [ ] Add system filtering controls (browser, Convex, workers)
  - [ ] Test UI responsiveness and debugging workflow user experience

- [ ] Task 2: Implement Redis-to-Convex Log Fetching (AC: 1, 3)
  - [ ] Create Convex action to fetch logs from Redis using Worker API
  - [ ] Implement trace ID-based Redis query functionality
  - [ ] Add error handling for Redis connection failures and missing logs
  - [ ] Implement caching to avoid redundant Redis calls during debug sessions
  - [ ] Test log fetching with various trace IDs and edge cases

- [ ] Task 3: Timeline Visualization Component (AC: 2)
  - [ ] Create chronological timeline component for log display
  - [ ] Implement system-based color coding and filtering
  - [ ] Add timestamp formatting and relative time display
  - [ ] Create expandable log entry details with context information
  - [ ] Test timeline visualization with various log patterns and volumes

- [ ] Task 4: Log Correlation Engine (AC: 4)
  - [ ] Implement error chain analysis across system boundaries
  - [ ] Create performance insight generation from log timing data
  - [ ] Add correlation pattern detection for common debugging scenarios
  - [ ] Implement cross-system request flow visualization
  - [ ] Test correlation engine with complex multi-system traces

- [ ] Task 5: Claude Code Integration & Log Export (AC: 5)
  - [ ] Create structured log export functionality (JSON, markdown formats)
  - [ ] Implement Claude Code-compatible debugging reports
  - [ ] Add pattern analysis summaries for AI assistance
  - [ ] Create copy-to-clipboard functionality for quick sharing
  - [ ] Test export functionality with various debugging scenarios

- [ ] Task 6: Performance Optimization & Caching (AC: 3)
  - [ ] Implement session-based log caching to reduce Redis calls
  - [ ] Add progressive loading for large trace datasets
  - [ ] Optimize timeline rendering for smooth user experience
  - [ ] Implement request deduplication during active debugging
  - [ ] Test performance with large log volumes and multiple concurrent sessions

- [ ] Task 7: Error Handling & User Experience Polish (AC: 6)
  - [ ] Add graceful error handling for Redis unavailability
  - [ ] Implement loading states and progress indicators
  - [ ] Create helpful error messages and debugging tips
  - [ ] Add keyboard shortcuts for efficient debugging workflows
  - [ ] Test error scenarios and user experience edge cases

## Documentation Impact Assessment

**Architectural Patterns Established:**

- On-demand logging architecture with Redis integration
- Debug interface patterns for developer tools
- Log correlation and analysis engine patterns
- Structured data export for AI assistance workflows
- Session-based caching patterns for performance optimization

**Documentation Updates Needed:**

- Add debug interface patterns to `docs/patterns/frontend-patterns.md`
- Update `docs/architecture/components.md` with debug interface integration
- Create debugging workflow guide in `docs/technical-guides/`
- Document log correlation patterns and AI integration workflows
- Add Redis integration examples for on-demand data fetching

**Knowledge Capture:**

- Debug interface design patterns for developer-focused tools
- Redis integration strategies for on-demand data retrieval
- Log correlation techniques for multi-system debugging
- Claude Code integration patterns for structured data export
- Performance optimization for large dataset visualization

**Examples to Create:**

- Debug interface implementation example
- Redis-to-Convex integration patterns
- Timeline visualization components
- Log correlation and analysis examples
- Claude Code debugging workflow integration

## Dev Notes

### Previous Story Insights

From [Source: 3.4.story.md - Implementation Results]:

**Redis Infrastructure Ready:**
- Redis storage with 1-hour TTL operational at Upstash
- Log ingestion Worker functional at localhost:8787 (dev) and production endpoint
- Multi-system log collection from browser, Convex, and workers established
- Environment-specific configuration system for dev/prod deployment

**Deprecated Convex Files Available for Reactivation:**
- `apps/convex/cleanup.deprecated.ts` - Log cleanup and maintenance functions
- `apps/convex/logCorrelation.deprecated.ts` - Log correlation and trace management  
- `apps/convex/rateLimiter.deprecated.ts` - Convex-based rate limiting
- Ready for Redis→Convex sync functionality implementation

**Current Architecture:**
- Browser → Log Ingestion Worker → Redis (1-hour TTL)
- No Convex integration for logs currently - this story adds the on-demand bridge
- Worker API available for fetching logs from Redis storage

### Data Models

From [Source: architecture/data-models.md]:

**Redis Log Structure (Available from Story 3.4):**

```typescript
// Redis Key Pattern: logs:{trace_id}
interface RedisLogEntry {
  id: string; // Unique log entry ID
  trace_id: string; // Correlation identifier
  user_id?: string; // User context
  system: 'browser' | 'convex' | 'worker' | 'manual';
  level: 'log' | 'info' | 'warn' | 'error';
  message: string; // Log message content
  stack?: string; // Stack trace if error
  timestamp: number; // Unix timestamp
  context?: Record<string, any>; // Additional metadata
}
```

**No Existing Debug Tables:** This story creates new interface - no existing log_entries table to integrate with.

### API Specifications

From [Source: architecture/api-implementation-details.md]:

**Required Debug Interface Actions:**

```typescript
// Fetch logs from Redis for debugging
"debug:fetchLogsForTrace": Action<{
  traceId: string;
  includeContext?: boolean;
  systemFilter?: Array<'browser' | 'convex' | 'worker'>;
}> -> {
  logs: Array<RedisLogEntry>;
  correlationAnalysis: {
    errorChains: Array<{ entries: RedisLogEntry[], pattern: string }>;
    performanceInsights: Array<{ metric: string, value: number, context: string }>;
    systemFlow: Array<{ system: string, timestamp: number, duration?: number }>;
  };
  exportData: {
    structured: object; // For Claude Code integration
    markdown: string; // Human-readable format
  };
}

// Export debug session for AI assistance
"debug:exportSession": Action<{
  traceId: string;
  format: 'json' | 'markdown' | 'claude-format';
  includeAnalysis?: boolean;
}> -> {
  exportContent: string;
  metadata: {
    traceId: string;
    exportTime: number;
    logCount: number;
    systems: string[];
  };
}
```

### Component Specifications

From [Source: architecture/source-tree.md]:

**New Debug Interface Structure:**

```
apps/web/app/debug/
├── page.tsx                 # Main debug interface page
├── components/
│   ├── TraceSearchForm.tsx  # Trace ID search and filtering
│   ├── TimelineViewer.tsx   # Chronological log timeline
│   ├── LogEntryCard.tsx     # Individual log entry display
│   ├── CorrelationPanel.tsx # Error chain and performance analysis
│   └── ExportControls.tsx   # Claude Code integration controls
└── lib/
    ├── debug-api.ts         # Convex debug action integration
    ├── log-correlation.ts   # Correlation analysis logic
    └── export-formatters.ts # Export format implementations
```

**Integration Points:**
- `/debug` page accessible from main navigation
- Convex actions for Redis data fetching
- Worker API integration for live Redis queries

### File Locations

From [Source: architecture/source-tree.md]:

**New Files to Create:**

- `apps/web/app/debug/page.tsx` - Main debug interface page
- `apps/web/app/debug/components/TraceSearchForm.tsx` - Search functionality
- `apps/web/app/debug/components/TimelineViewer.tsx` - Timeline visualization
- `apps/web/app/debug/components/LogEntryCard.tsx` - Log entry display
- `apps/web/app/debug/components/CorrelationPanel.tsx` - Analysis panel
- `apps/web/app/debug/components/ExportControls.tsx` - Export functionality
- `apps/web/app/debug/lib/debug-api.ts` - API integration utilities
- `apps/web/app/debug/lib/log-correlation.ts` - Correlation logic
- `apps/web/app/debug/lib/export-formatters.ts` - Export formatting
- `apps/convex/debugActions.ts` - Debug-related Convex actions
- `apps/convex/lib/redisLogFetcher.ts` - Redis integration for log fetching

**Files to Reactivate/Modify:**
- `apps/convex/logCorrelation.deprecated.ts` → `apps/convex/logCorrelation.ts` (adapt for on-demand use)
- Update main navigation to include debug interface link

### Technical Architecture

From [Source: architecture/tech-stack.md]:

**Debug Interface Technology Stack:**
- **Next.js App Router** - Debug page routing and server components
- **React 18** - Timeline visualization and interactive components  
- **Tailwind CSS + ShadCN UI** - Clean, developer-focused interface styling
- **Convex Actions** - Redis data fetching and log correlation processing
- **Redis REST API** - Direct integration with Upstash Redis for log retrieval
- **TypeScript** - Strict typing for log data structures and correlation analysis

### Integration Patterns

From [Source: 3.4.story.md - Architecture]:

**Redis Integration Pattern:**

```typescript
// Fetch logs from Redis via Worker API
const fetchLogsFromRedis = async (traceId: string) => {
  const response = await fetch(`${WORKER_ENDPOINT}/logs/${traceId}`, {
    method: 'GET',
    headers: { 'Authorization': `Bearer ${API_KEY}` }
  });
  
  if (!response.ok) {
    throw new ConvexError(`Failed to fetch logs: ${response.status}`);
  }
  
  const logs: RedisLogEntry[] = await response.json();
  return logs.sort((a, b) => a.timestamp - b.timestamp);
};
```

**Debug Session Pattern:**

```typescript
// Session-based caching for debug interface
const DEBUG_CACHE_TTL = 300_000; // 5 minutes
const debugSessions = new Map<string, {
  logs: RedisLogEntry[];
  correlationData: CorrelationAnalysis;
  fetchTime: number;
}>();

export const getDebugSession = async (traceId: string) => {
  const cached = debugSessions.get(traceId);
  if (cached && Date.now() - cached.fetchTime < DEBUG_CACHE_TTL) {
    return cached;
  }
  
  // Fetch fresh data from Redis
  const logs = await fetchLogsFromRedis(traceId);
  const correlationData = await analyzeLogCorrelation(logs);
  
  const session = { logs, correlationData, fetchTime: Date.now() };
  debugSessions.set(traceId, session);
  return session;
};
```

### Claude Code Integration Strategy

**Structured Export Format:**

```typescript
interface ClaudeDebugExport {
  metadata: {
    traceId: string;
    exportTime: string;
    logCount: number;
    systems: string[];
    timeRange: { start: number, end: number };
  };
  timeline: Array<{
    timestamp: string;
    system: string;
    level: string;
    message: string;
    context?: any;
  }>;
  analysis: {
    errorChains: Array<{
      description: string;
      entries: Array<{ timestamp: string, system: string, message: string }>;
    }>;
    performanceIssues: Array<{
      issue: string;
      evidence: string;
      recommendation: string;
    }>;
    systemFlow: Array<{
      system: string;
      actions: string[];
      duration: string;
    }>;
  };
  summary: string;
}
```

### Security and Access Control

From [Source: 3.4.story.md - Security]:

**Debug Interface Access:**
- Require authenticated user context for all debug operations
- Implement session-based access control for debug functionality
- Rate limiting on Redis fetch operations to prevent abuse
- Audit logging for all debug sessions and export operations

### Testing Requirements

From [Source: docs/testing/technical/test-strategy-and-standards.md]:

**Test File Locations:**
- `apps/web/app/debug/__tests__/debug-interface.test.tsx` - Interface component tests
- `apps/web/app/debug/__tests__/log-correlation.test.ts` - Correlation logic tests
- `apps/convex/__tests__/debugActions.test.ts` - Debug action unit tests
- `tests/e2e/debug-interface.spec.ts` - End-to-end debug workflow tests

**Testing Standards:**
- Mock Redis responses for consistent debug interface testing
- Test timeline visualization with various log patterns and edge cases
- Validate correlation analysis accuracy with known log scenarios
- Test export functionality across different formats and data sizes
- Performance testing for large log datasets and visualization rendering

**Coverage Requirements:**
- 85%+ statements coverage for correlation analysis logic
- Integration tests for complete debug workflow (search → fetch → analyze → export)
- Error path testing for Redis unavailability and malformed log data
- UI interaction testing for timeline navigation and filtering

### Technical Constraints

From [Source: architecture/coding-standards.md]:

**Mandatory Requirements:**
- No `any` types - use proper TypeScript interfaces for all log data structures
- Include correlation IDs in all debug operations for traceability
- Follow repository pattern for Redis data access abstraction
- No direct `process.env` access - use centralized configuration

**Performance Requirements:**
- Timeline must render smoothly with 1000+ log entries
- Search results must appear within 2 seconds for typical trace volumes
- Export generation must complete within 5 seconds for standard debugging sessions
- Memory usage must remain under 100MB for large debugging sessions

## Change Log

| Date       | Version | Description                 | Author                              |
| ---------- | ------- | --------------------------- | ----------------------------------- |
| 2025-01-31 | 1.0     | Initial story draft created | BMad Agent (create-next-story task) |

## Dev Agent Record

### Agent Model Used

_To be populated during implementation_

### Debug Log References

_To be populated during implementation_

### Completion Notes List

_To be populated during implementation_

### File List

_To be populated during implementation_

## QA Results

_Quality assurance results will be documented here after implementation._
# Story 4.2: Implement the Knowledge Ingestion Service

## Status

Draft

## Story

**As a** developer,
**I want** a backend service to process documents, create vector embeddings, and store them in our Vector DB,
**so that** our AI has a knowledge base to retrieve context from.

## Acceptance Criteria

1. A Convex action `knowledge:addDocument` is created.
2. This action takes text content as input.
3. It uses a library to generate vector embeddings for chunks of the document text.
4. The text chunks and their embeddings are successfully stored in our Cloudflare Vectorize DB.
5. The seeding script is configured to process all key project documents in `/docs` and key source code files in `apps/` and `packages/`.

## Estimation & Planning

### Story Points

8

### Estimated Complexity

Medium-High

### Estimated Time

3-4 days

### Risk Level

Medium

## Tasks / Subtasks

- [ ] Task 1: Create Convex Action for Document Processing (AC: 1, 2)
  - [ ] Create `knowledge:addDocument` action in `apps/convex/knowledge.ts`
  - [ ] Implement input validation for text content parameter
  - [ ] Add proper TypeScript types and error handling
  - [ ] Test action creation and parameter validation

- [ ] Task 2: Implement Text Chunking and Embedding Generation (AC: 3)
  - [ ] Research and integrate vector embedding library (OpenAI embeddings API or similar)
  - [ ] Implement text chunking algorithm with configurable chunk size
  - [ ] Add overlap between chunks for better context preservation
  - [ ] Create embedding generation with error handling and retries
  - [ ] Test chunking algorithm with various document types

- [ ] Task 3: Integrate Cloudflare Vectorize DB Storage (AC: 4)
  - [ ] Configure Cloudflare Vectorize database connection in Convex
  - [ ] Implement storage mechanism for text chunks and embeddings
  - [ ] Add metadata storage (document source, chunk index, timestamps)
  - [ ] Create unique document identification and deduplication
  - [ ] Test vectorize integration with sample documents

- [ ] Task 4: Create Document Seeding Script (AC: 5)
  - [ ] Create seeding script to process `/docs` directory recursively
  - [ ] Add support for markdown file processing
  - [ ] Include source code file processing from `apps/` and `packages/`
  - [ ] Implement file filtering (ignore node_modules, build outputs, etc.)
  - [ ] Add progress tracking and error reporting for bulk processing
  - [ ] Test seeding script with project documentation

- [ ] Task 5: Add Comprehensive Testing
  - [ ] Unit tests for chunking algorithm
  - [ ] Integration tests for embedding generation
  - [ ] Tests for Vectorize DB storage operations
  - [ ] End-to-end tests for complete document ingestion workflow
  - [ ] Performance tests for large document processing

## Documentation Impact Assessment

**Architectural Patterns Established:**

- Knowledge ingestion and vector embedding patterns
- Cloudflare Vectorize integration with Convex Actions
- Document processing and chunking strategies
- Bulk data seeding and migration patterns

**Documentation Updates Needed:**

- Add knowledge service to `docs/architecture/api-implementation-details.md`
- Update `docs/architecture/data-models.md` with vector storage schema
- Create vector search patterns in `docs/patterns/backend-patterns.md`
- Add Vectorize integration guide to `docs/technical-guides/`

**Knowledge Capture:**

- Vector embedding best practices and chunk sizing strategies
- Cloudflare Vectorize configuration and performance considerations
- Document processing patterns for various file types
- Bulk ingestion performance optimization techniques

**Examples to Create:**

- Knowledge ingestion API usage examples
- Vector embedding and chunking examples
- Vectorize database integration patterns

## Dev Notes

### Technical Architecture

From [Source: architecture/tech-stack.md]:

- **Convex 1.12.x** for Actions to handle external API calls and integrations
- **Cloudflare Vectorize DB** for vector storage and similarity search
- **TypeScript 5.4.x** with strict mode enforcement for type safety
- **Vercel AI SDK** or **OpenAI SDK** for embeddings generation
- **Zod 3.23.x** for schema validation and input validation

### Previous Story Insights

From [Source: 4.1.story.md - Dev Agent Record]:

- Chat UI infrastructure is complete with proper TypeScript types
- Established patterns for message handling and real-time updates
- Created chat types at `apps/web/types/chat.ts` - extend for knowledge context
- Implemented proper error handling and loading states
- Console override system available for debugging RAG integration

### Data Models

From [Source: architecture/data-models.md]:

**Existing Schema Foundation:**

- `users` table with user context and IDs for security
- `chat_sessions` and `chat_messages` for conversation tracking
- `log_entries` with correlation_id patterns for debugging

**Required Extensions for Vector Storage:**

- New table/collection for document chunks with metadata
- Vector embeddings stored in Cloudflare Vectorize (external to Convex)
- Mapping table to link Convex documents to Vectorize entries
- Source document tracking with file paths and modification times

### API Specifications

From [Source: architecture/api-implementation-details.md]:

**Required Convex Action Signature:**

```typescript
// New action to be implemented
"knowledge:addDocument": Action<{
  content: string;
  source: string;
  metadata?: object;
}> -> { documentId: string; chunksCreated: number; }

// Future RAG query action (referenced for context)
"agent:runRAGQuery": Action<{
  sessionId: Id<"chatSessions">;
  message: string;
}> -> void
```

**Integration Requirements:**

- Use Actions (not Mutations) for external Vectorize API calls
- Follow repository pattern for data access abstraction
- Include correlation IDs for all operations (from logging patterns)

### File Locations

From [Source: architecture/source-tree.md]:

**New Files to Create:**

- `apps/convex/knowledge.ts` - Knowledge ingestion actions
- `apps/convex/schema.ts` - Update with document metadata tables
- `scripts/seed-knowledge.ts` - Document seeding script
- `packages/shared-types/knowledge.ts` - Shared types (if needed)

**Configuration Files:**

- Environment variables for Vectorize DB connection in `.env.local`
- Cloudflare Vectorize configuration (external to codebase)

### Integration Patterns

From [Source: patterns/backend-patterns.md]:

**Action Function Structure:**

- Use `action()` wrapper for external API integrations
- No direct database access from actions - call mutations for Convex data
- Handle external API errors with proper retry logic
- Include proper logging with correlation IDs

**External API Integration Pattern:**

```typescript
export const addDocument = action({
  args: { content: v.string(), source: v.string() },
  handler: async (ctx, args) => {
    // Generate embeddings via external API
    // Store in Vectorize DB
    // Update Convex metadata via mutation
    // Return results with proper error handling
  },
});
```

### Cloudflare Vectorize Configuration

From [Source: architecture/high-level-architecture.md]:

**Platform Integration:**

- Cloudflare Vectorize DB for vector storage and similarity search
- Edge-first architecture ensures global performance
- Integration with existing Cloudflare infrastructure (Pages, Workers)

**Required Setup:**

- Vectorize database creation via Cloudflare dashboard or API
- API keys and endpoint configuration
- Index configuration for vector dimensions (typically 1536 for OpenAI embeddings)

### Testing Requirements

From [Source: testing/technical/test-strategy-and-standards.md]:

**Test File Locations:**

- `apps/convex/__tests__/knowledge.test.ts` - Action unit tests
- `scripts/__tests__/seed-knowledge.test.ts` - Seeding script tests

**Testing Standards:**

- Use Jest for unit tests with proper mocking of external APIs
- Mock Vectorize API calls during testing
- Test error scenarios and edge cases
- Include performance tests for large document processing
- Validate embedding quality and chunking effectiveness

**Coverage Requirements:**

- 85%+ statements coverage for knowledge ingestion logic
- Integration tests for complete document processing workflow
- Error path testing for external API failures

### Technical Constraints

From [Source: architecture/coding-standards.md]:

**Mandatory Requirements:**

- No `any` types - use proper TypeScript interfaces
- Include correlation IDs in all operations for traceability
- Follow repository pattern for data access abstraction
- No direct `process.env` access - use centralized configuration

**Security Considerations:**

- Validate all input content before processing
- Sanitize file paths and sources
- Rate limiting for bulk operations
- API key security for external embedding services

### Pattern Validation

Must follow established patterns from previous stories:

**Convex Function Patterns:**

- Consistent error handling with ConvexError
- Proper argument validation with Convex validators
- Type-safe function signatures and return values
- Correlation ID inclusion for debugging and tracing

**External Integration Patterns:**

- Use Actions for all external API calls (Vectorize, embedding APIs)
- Implement retry logic with exponential backoff
- Handle API rate limits and quota restrictions
- Proper logging of external service interactions

## Change Log

| Date       | Version | Description                 | Author                              |
| ---------- | ------- | --------------------------- | ----------------------------------- |
| 2025-01-25 | 1.0     | Initial story draft created | BMad Agent (create-next-story task) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent during implementation_

### Debug Log References

_To be populated by development agent during implementation_

### Completion Notes List

_To be populated by development agent during implementation_

### File List

_To be populated by development agent during implementation_

## QA Results

_Quality assurance results will be documented here after implementation._

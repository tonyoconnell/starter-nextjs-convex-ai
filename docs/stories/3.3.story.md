# Story 3.3: System Admin Monitoring & Controls

## Status

Ready

## Story

**As a** developer,
**I want** administrative controls and monitoring tools to manage the logging system's health, performance, and costs,
**so that** I can maintain optimal system operation and troubleshoot issues effectively.

## Acceptance Criteria

1. Rate limiting status dashboard shows current usage across all systems (browser, worker, backend) with real-time quota management.
2. Cost and budget monitoring displays monthly write usage, estimated costs, and budget remaining with configurable alerts.
3. Database health monitoring shows storage usage, record counts, and cleanup recommendations.
4. Administrative cleanup controls provide both safe maintenance cleanup and emergency full cleanup options.
5. Log correlation search enables querying logs by trace ID, message content, system, or time range for troubleshooting.
6. **Developer Experience**: System health overview provides at-a-glance status of all logging components and potential issues.

## Estimation & Planning

### Story Points
8

### Estimated Complexity
Medium-High

### Estimated Time
3-4 days

### Risk Level
Medium

## Tasks / Subtasks

- [x] Task 1: Create Admin Dashboard Page Structure (AC: 1, 2, 3, 6)
  - [x] Create `/admin/logs` page with navigation
  - [x] Implement responsive layout for monitoring cards
  - [x] Add navigation integration with existing app structure
  - [x] Create loading states and error boundaries

- [ ] Task 2: Rate Limiting Status Display Component (AC: 1)
  - [ ] Build real-time rate limit status widget
  - [ ] Display current/limit for browser, worker, backend systems
  - [ ] Show quota borrowing and reset timers
  - [ ] Add manual rate limit reset controls

- [ ] Task 3: Cost & Budget Monitoring Component (AC: 2)
  - [ ] Create cost tracking dashboard widget
  - [ ] Display monthly write usage breakdown by system
  - [ ] Show estimated costs and budget remaining
  - [ ] Implement configurable alert thresholds
  - [ ] Add budget usage trending visualizations

- [ ] Task 4: Database Health Monitoring Component (AC: 3)
  - [ ] Build storage usage monitoring widget
  - [ ] Display record counts for log tables
  - [ ] Show cleanup recommendations
  - [ ] Add database size alerts and warnings

- [ ] Task 5: Administrative Cleanup Controls (AC: 4)
  - [ ] Create cleanup management interface
  - [ ] Implement safe cleanup button with confirmation
  - [ ] Add emergency cleanup with strong warnings
  - [ ] Show cleanup status and results
  - [ ] Add cleanup history and scheduling options

- [ ] Task 6: Log Correlation Search Interface (AC: 5)
  - [ ] Build advanced log search component
  - [ ] Support search by trace ID, message content, system, time range
  - [ ] Display correlated log results with trace timelines
  - [ ] Add export functionality for search results
  - [ ] Implement search history and saved searches

- [ ] Task 7: System Health Overview Dashboard (AC: 6)
  - [ ] Create unified health status widget
  - [ ] Aggregate status from all monitoring components
  - [ ] Display system alerts and recommendations
  - [ ] Add quick action buttons for common tasks
  - [ ] Implement automatic refresh and real-time updates

## Documentation Impact Assessment

**Architectural Patterns Established:**
- Admin dashboard page structure for system management
- Real-time monitoring widget pattern with Convex integration
- Administrative action confirmation patterns
- Complex data visualization component architecture

**Documentation Updates Needed:**
- Add admin dashboard to `docs/architecture/components.md`
- Update source tree documentation for new admin pages
- Create monitoring patterns in `docs/patterns/frontend-patterns.md`
- Add admin UI examples to `docs/examples/frontend/`

**Knowledge Capture:**
- Best practices for real-time monitoring dashboards in Next.js
- Convex integration patterns for administrative functions
- Data visualization and chart component patterns
- Security considerations for admin interfaces

**Examples to Create:**
- Admin dashboard implementation example
- Real-time monitoring widget patterns
- Convex administrative function usage examples

## Dev Notes

### Previous Story Insights

From Story 3.2 completion, we have a comprehensive foundation:
- **Centralized Rate Limiting Service**: `apps/convex/rateLimiter.ts` with 15 functions
- **Multi-System Log Correlation Engine**: `apps/convex/logCorrelation.ts` with 5 query functions  
- **Database Protection Architecture**: Full monitoring and cleanup system implemented
- **Cost Monitoring Functions**: Budget tracking and usage analysis ready
- **All Backend Functions Implemented**: 15 total functions across categories ready for UI integration

### Data Models

From [Source: architecture/data-models.md#log_entries] and Story 3.2 implementation:
- **`rate_limit_state` table**: Single row with browser/worker/backend quotas and global budget tracking
- **`message_fingerprints` table**: Duplicate detection with fingerprint hashing
- **`log_queue` table**: Processing queue for log entries with trace correlation
- **`recent_log_entries` table**: Real-time viewing table with system_area tagging
- **Extended schema**: All protection patterns implemented and operational

### API Specifications

From [Source: architecture/api-implementation-details.md] and Story 3.2 implementation:

**Rate Limiting Functions** (Ready for Integration):
```typescript
// All implemented in apps/convex/rateLimiter.ts
rateLimiter:getRateLimitState() -> SystemRateLimits
rateLimiter:getCostMetrics() -> CostMetrics  
rateLimiter:updateRateLimitState() -> UpdateResult
rateLimiter:getCalculatedLimits() -> LimitCalculations
```

**Monitoring Functions** (Ready for Integration):
```typescript
// All implemented in apps/convex/monitoring.ts
monitoring:usage() -> DatabaseUsageMetrics
monitoring:traces() -> HighVolumeTraceAnalysis
```

**Cleanup Functions** (Ready for Integration):
```typescript
// All implemented in apps/convex/cleanup.ts
cleanup:status() -> CleanupStatusReport
cleanup:safe() -> SafeCleanupResult
cleanup:force() -> ForceCleanupResult
```

**Log Correlation Functions** (Ready for Integration):
```typescript
// All implemented in apps/convex/logCorrelation.ts
logCorrelation:getCorrelatedLogs(trace_id) -> CorrelatedLogResult
logCorrelation:searchLogs(query) -> SearchResults
logCorrelation:getRecentTraces() -> RecentTraceActivity
logCorrelation:getTraceInsights(trace_id) -> TraceInsights
logCorrelation:getCorrelationStats() -> CorrelationStatistics
```

### Component Specifications

From [Source: architecture/source-tree.md] and existing patterns:

**File Locations**:
- Admin pages: `apps/web/app/admin/logs/page.tsx` (new)
- Monitoring components: `apps/web/components/admin/` (new directory)
- Shared admin utilities: `apps/web/lib/admin-utils.ts` (new)
- Admin-specific types: `apps/web/types/admin.ts` (new)

**Component Architecture Pattern**:
```typescript
// Following established patterns from Story 2.3 showcase page
interface MonitoringWidgetProps {
  title: string;
  data: any;
  loading?: boolean;
  error?: string;
  onRefresh?: () => void;
  actions?: ReactNode;
}
```

### File Locations

Based on [Source: architecture/source-tree.md]:
- **Admin Dashboard**: `apps/web/app/admin/logs/page.tsx`
- **Monitoring Components**: `apps/web/components/admin/` directory
- **Admin Layout**: `apps/web/app/admin/layout.tsx`
- **Admin Utilities**: `apps/web/lib/admin-utils.ts`
- **Admin Types**: `apps/web/types/admin.ts`

### Testing Requirements

From [Source: architecture/coding-standards.md]:
- All code must be fully type-safe (no `any` types)
- Test files in `__tests__/` directories alongside source files
- Integration tests for Convex function calls
- Unit tests for component logic and data transformations
- E2E tests for critical admin workflows

### Technical Constraints

From [Source: architecture/tech-stack.md]:
- Next.js 14.2.x with App Router for admin pages
- TypeScript 5.4.x with strict mode enforcement
- Convex 1.12.x for real-time data queries
- ShadCN UI components for consistent admin interface
- Tailwind CSS for responsive admin layouts

### Cost Constraint Integration

From Story 3.2 implementation:
- **$10/month budget**: 125,000 total writes maximum
- **Real-time cost tracking**: Every write operation updates cost tracker
- **Budget allocation**: 40% browser, 30% worker, 30% backend
- **Protection thresholds**: Warning at 80%, critical at 95%, cutoff at 100%
- **Admin controls needed**: Manual reset, budget adjustment, quota reallocation

### Security Considerations

From [Source: architecture/security.md]:
- Admin interface requires authentication
- Administrative actions need confirmation dialogs
- Cleanup operations require elevated permissions
- Rate limit modifications logged for audit trail
- No sensitive data exposed in monitoring displays

## Pattern Validation

### Testing Standards

From [Source: architecture/coding-standards.md]:
- **Test File Locations**: `__tests__/` directories alongside source files
- **Testing Frameworks**: Jest for unit tests, React Testing Library for component tests
- **Admin Component Testing**: Must include state management, data loading, error handling
- **Integration Testing**: Convex query integration, real-time updates, error boundaries
- **E2E Testing**: Critical admin workflows with Playwright

### Pattern Compliance

Must follow patterns established in Stories 2.3 (showcase) and 3.1 (logging):
- Responsive card-based layout for monitoring widgets
- Real-time data updates with Convex `useQuery` hooks
- Loading states and error boundaries for all data components
- Confirmation dialogs for destructive admin actions
- Consistent ShadCN UI component usage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-25 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

James (Full Stack Developer) - Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

- Fixed import path issues for convex-backend module
- Updated UI component imports to use @starter/ui pattern  
- Created JavaScript mock for convex-backend module to support Jest testing
- Resolved path alias issues in tsconfig.json

### Completion Notes List

**Task 1 Implementation (2025-01-25):**
- ✅ Created complete admin dashboard page structure at `/admin/logs`
- ✅ Implemented all 6 monitoring components with real-time Convex integration
- ✅ Added comprehensive test suite for all admin components
- ✅ Fixed module resolution and import path issues
- ✅ Integrated ShadCN UI components from packages/ui monorepo structure

**Components Created:**
- RateLimitStatus: Real-time rate limiting monitoring with progress bars
- CostMonitoring: Budget tracking with cost breakdown by system
- DatabaseHealth: Storage usage monitoring with cleanup recommendations  
- CleanupControls: Administrative cleanup interface with confirmation dialogs
- LogSearch: Advanced log correlation search with export functionality
- SystemHealthOverview: Unified health dashboard aggregating all system status

**Architecture Established:**
- Monorepo UI component integration pattern
- Real-time monitoring widget pattern with Convex
- Administrative confirmation dialog patterns
- Responsive card-based admin layout

### File List

**Pages & Layouts:**
- `apps/web/app/admin/layout.tsx` - Admin section layout with consistent styling
- `apps/web/app/admin/logs/page.tsx` - Main admin dashboard with tabbed interface

**Admin Components:**
- `apps/web/components/admin/rate-limit-status.tsx` - Rate limiting status display
- `apps/web/components/admin/cost-monitoring.tsx` - Cost & budget monitoring
- `apps/web/components/admin/database-health.tsx` - Database health monitoring  
- `apps/web/components/admin/cleanup-controls.tsx` - Administrative cleanup controls
- `apps/web/components/admin/log-search.tsx` - Log correlation search interface
- `apps/web/components/admin/system-health-overview.tsx` - System health overview

**Test Files:**
- `apps/web/components/admin/__tests__/rate-limit-status.test.tsx`
- `apps/web/components/admin/__tests__/cost-monitoring.test.tsx`
- `apps/web/components/admin/__tests__/database-health.test.tsx`
- `apps/web/components/admin/__tests__/cleanup-controls.test.tsx`
- `apps/web/components/admin/__tests__/log-search.test.tsx`
- `apps/web/components/admin/__tests__/system-health-overview.test.tsx`

**UI Package Updates:**
- `packages/ui/src/alert.tsx` - Alert component for admin notifications
- `packages/ui/src/alert-dialog.tsx` - Confirmation dialogs for admin actions
- `packages/ui/src/badge.tsx` - Status badges for monitoring displays
- `packages/ui/src/progress.tsx` - Progress bars for usage indicators
- `packages/ui/src/tabs.tsx` - Tab interface for admin dashboard
- `packages/ui/src/label.tsx` - Form labels for admin controls
- `packages/ui/src/select.tsx` - Dropdown selects for admin filters
- `packages/ui/package.json` - Updated dependencies and exports
- `packages/ui/index.ts` - Updated component exports

**Type Definitions:**
- `apps/web/types/convex-backend.d.ts` - Extended with admin function types
- `apps/web/types/convex-backend.js` - Jest mock for testing support

## QA Results

*This section will be populated by the QA agent after story completion*

### Pattern Compliance Review

*To be completed during QA review*

### Knowledge Capture

*To be completed during QA review*

### Velocity Data

*To be completed during QA review*